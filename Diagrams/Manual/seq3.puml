@startuml End_Trip_with_Payment
actor User
participant "App Interface" as App
participant ":Trip" as TripObj
participant ":Vehicle" as Bike
participant ":ParkingLot" as Parking
participant ":RateCard" as Rates
participant ":Wallet" as WalletObj
participant ":Transaction" as TransObj
participant ":Feedback" as FeedbackObj

User -> App: requestEndTrip()
activate App

App -> TripObj: endTrip()
activate TripObj

TripObj -> Bike: getGPSLocation()
activate Bike
Bike --> TripObj: currentLocation
deactivate Bike

TripObj -> Parking: isBikeInside(gpsLocation)
activate Parking

alt Inside Parking Geofence
    Parking --> TripObj: locationValid
    deactivate Parking
    
    TripObj -> TripObj: calculateDuration()
    TripObj -> TripObj: calculateDistance()
    
    TripObj -> Rates: calculateFare(distance, duration)
    activate Rates
    
    Rates -> Rates: applyBaseRate()
    Rates -> Rates: applyDistanceRate()
    Rates -> Rates: checkDailyFine()
    Rates --> TripObj: totalFare
    deactivate Rates
    
    TripObj -> WalletObj: deductMoney(totalFare)
    activate WalletObj
    
    alt Sufficient Balance
        WalletObj -> WalletObj: updateBalance()
        WalletObj -> TransObj: create(amount, timestamp)
        activate TransObj
        TransObj --> WalletObj: transactionRecorded
        deactivate TransObj
        
        WalletObj --> TripObj: paymentSuccessful
        deactivate WalletObj
        
        TripObj -> Bike: lock()
        activate Bike
        Bike -> Bike: updateStatus(AVAILABLE)
        Bike --> TripObj: locked
        deactivate Bike
        
        TripObj -> Parking: updateAvailability()
        activate Parking
        Parking --> TripObj: availabilityUpdated
        deactivate Parking
        
        TripObj --> App: tripCompleted
        App --> User: displayTripSummary()
        
        User -> App: submitRating()
        App -> FeedbackObj: create(rating, comment)
        activate FeedbackObj
        FeedbackObj --> App: feedbackRecorded
        deactivate FeedbackObj
        
        App --> User: displayThankYou()
        
    else Insufficient Balance
        WalletObj --> TripObj: insufficientFunds
        deactivate WalletObj
        
        TripObj --> App: paymentFailed
        App --> User: redirectToPaymentGateway()
    end
    
else Outside Parking Fence 
    Parking --> TripObj: locationInvalid
    deactivate Parking
    
    TripObj --> App: invalidParkingLocation
    App --> User: displayParkingError()
end

deactivate TripObj
deactivate App
@enduml